# -*- coding:utf-8 -*-

"""

created by shuangquan.huang at 2020/8/24

"""

import collections
import time
import os
import sys
import bisect
import heapq
from typing import List

import itertools
from functools import lru_cache

class Solution:
    def minimalSteps(self, maze: List[str]) -> int:
        N, M = len(maze), len(maze[0])
        sx, sy, ex, ey = -1, -1, -1, -1
        traps = []
        stones = []
        for r in range(N):
            for c in range(M):
                if maze[r][c] == 'S':
                    sx, sy = r, c
                if maze[r][c] == 'T':
                    ex, ey = r, c
                if maze[r][c] == 'M':
                    traps.append((r, c))
                if maze[r][c] == 'O':
                    stones.append((r, c))
        
        numtrap = len(traps)
        
        # start to O
        # O to M
        # M to O
        # M to end
        INF = 10 ** 9 + 7
        
        def spfa(r, c):
            dist = [[INF for _ in range(M)] for _ in range(N)]
            q = collections.deque([(r, c)])
            dist[r][c] = 0
            while q:
                x, y = q.popleft()
                for nx, ny in [(x+1, y), (x-1, y), (x, y+1), (x, y-1)]:
                    if 0 <= nx < N and 0 <= ny < M and maze[nx][ny] != '#' and dist[nx][ny] > dist[x][y] + 1:
                        dist[nx][ny] = dist[x][y] + 1
                        q.append((nx, ny))
                        
            return dist
        
        diststart = spfa(sx, sy)
        
        if numtrap <= 0:
            return diststart[ex][ey] if diststart[ex][ey] < INF else -1
        
        disttrap = []
        for r, c in traps:
            disttrap.append(spfa(r, c))
            
            
        distintrap = [[INF for _ in range(numtrap)] for _ in range(numtrap)]
        for ia in range(numtrap):
            for ib in range(ia+1, numtrap):
                distintrap[ia][ib] = min(disttrap[ia][r][c] + disttrap[ib][r][c] for r, c in stones)
                distintrap[ib][ia] = distintrap[ia][ib]
                
        @lru_cache(maxsize=None)
        def dfs(index, state, done):
            # print(index, state, done)
            if done == 1:
                return min([diststart[r][c] + disttrap[index][r][c] for r, c in stones])

            ans = INF
            prestate = state ^ (1 << index)
            for i in range(numtrap):
                if i == index or (state & (1 << i) == 0):
                    continue
                    
                precost = dfs(i, prestate, done-1)
                ans = min(ans, precost + distintrap[i][index])
            
            return ans
        
        
        t0 = time.time()
        ans = min(dfs(i, (1 << numtrap) - 1, numtrap) + disttrap[i][ex][ey] for i in range(numtrap))
        print('inner', time.time() - t0)
        return ans if ans < INF else -1
        
        
        
                    

if __name__ == '__main__':
    s = Solution()
    print(s.minimalSteps([
        "S#O",
        "M.#",
        "M.T"]))
    print(s.minimalSteps(["MMMMM","MS#MM","MM#TO"]))
    # print(s.minimalSteps(["..#..",".S#..","..#T#"]))
    # print(s.minimalSteps(["##TOO#O#", "OO##O.S#", "###.O###", "#..O#O##"]))
    # print(s.minimalSteps(
    #     [
    #         "##TOO#O#",
    #         "OO##O.S#",
    #         "###.O###",
    #         "#..O#O##"]
    # ))
    # print(s.minimalSteps([
    #     "MMMMM",
    #     "MS#MM",
    #     "MM#TO"]))
    # print(s.minimalSteps(["S#O", "M..", "M.T"]))
    # print(s.minimalSteps( ["S#O", "M.#", "M.T"]))
    # print(s.minimalSteps(["S#O", "M.T", "M.."]))
    #
    # t0 = time.time()
    # print(s.minimalSteps(["#...#...#.#...#.##...#......##........#...#.#.#......##......#.#......#.#..", "#.#...#....#.............#.##..#......#........##..#....#...........#......", "..#.......#.##.##..#...#..#...#.#...............#....#..#..##......#.#..#..", ".......#.#........#.....###..#........#...#..##.......#.....#.#............", ".##....#...#....#...##....................#..#.##...##..#.#.#.......#....#.", ".#.#.....#........#...............#....##..#......#...##.#..#...##..#.#.##.", ".#......#.##..#.#..#..........#.........#......####.....#.#.....####...#...", ".......#..........#.##.#..#..................#...#......#.#...#..#.#..##.#.", "..#....#..##.....#.##..........#.......#.......#..............#.##..#.##..#", "......#........##..#.#..#...#.#..##.........#..###.....#.#...#...#..#.####.", ".#...#.........##........###...#..#....#.....#....#....##......##....#...##", "..........#.#........................#...##....#.#.#.............##.#.#..#.", "....#..#.........#.......#..#.......#.##........####....##..##...#..#......", "..##.....#..#....#.........#...###.#.##.#..#.........#..#...##.#........#..", ".#...#...##.#.......................#..#.....#...................#..##...#.", "..........#............#...##............##....#..#.....#....#..#..........", "#....#.#...##..###......T.#.#...##.....#...#.......#.##......#...#..#..#.#.", "......#...............##........##.#.......#.......#.....#.#..#.........##.", ".#...##.....#......#.##.....#......#.#.......#...#...............##.##.....", "#..........#.#.###...#...#......#..##......#....#.......###..M.#.....##....", ".................#....###..#....#.##.#...##......##..................#.....", "................#...#.....#...#..#..#.#....#............#.#..#.......#...#.", "....#..#..........#...#######....#...#...#.....#####..#....#..#..#......#..", "...#.......#.....#....#......#..##..#.............#..#......##...##...#..#.", "........##..#.#.....#...#.....M#...#..#.#..##..##...#...#....#..........#.#", ".#....##...#.#.#.#..#..#.#.#..#...#.#.....#.......#......#..###..#..#.##...", "..#....#.##.......##.....###...#.####.......#......#..#...#.#....#....#.##.", "...#..#..#.....##.......#...........#.....#.#..#...#.#....##...#.##....#...", ".....#...#.#..#..#..#.......#..##...#.....#M.#.......#.....#.#......#.....#", "...#........#.....#...#....#..#..#.#.....##.#...##..........##......#.#..##", "..........#.##.#..###...#..###..##.....#.##....#....#...#..#..#..#...#...#.", "......##........###..#.#.#......#.........#.......#...#...#................", ".#.#......#........##...#................#.##.........####..#..##..#.#.#...", ".##.##.#.........#.....##.#.#......#..##.#..###......##.#..##.#.######...#.", "##.#...#...##.#.#..#......#...............#..................#......#.##..#", ".......#.#.##.#.#.##..#.#..#.##...#...........#...#....#..##.....#....#.#..", "#.............#......#.##....#...#.#..#.............###...............#....", "...##...#..#.........#.#.##.##..##..###.###..#....#........#..##....##.##..", ".#..#.#..#.#....####......#...#............................#.....#....##...", "......#..#...#...#.............#...#.........###........#..#..M....#.......", "..#.##..........#.......##.#......##..#.....#.....#...##......##..........#", "#...#.#.#.....##.#.....#....#...........##........#....#....#..##...#..#.#.", "...##....#...#...........##.#......##.....#.......##..#..........#.........", "..............#.....#..##..#.....#....##.....#.#.............#..###....#.#.", "...##...#....##.#.....#....#...##..#..#.#........##..##.......#...#..###...", "#....#.....#................#.....#.......##................###............", "....##.#....#...............#.......#......#...#...###............##..#.#..", ".###.###...#..#..#.#.............#..#..#.#..........#.....#....#.#.....#...", "#.....##.#......###.#..........#..#.........#...................#....###...", "#.###....##..#...#.#....M.......#.#..........#.........#....#####...#......", ".##.#...............##...#..........#...#..#..........#..##...#.#.#.....#..", ".#......#..#......##........#...#......#.#..#.#.....##.##.#..#....#.##...#.", "...#.#..##.........##.#........#.........#.##..####..##..#..#...#...##...#.", ".#.....#.............##....#..#...#...##..##..##.....##.....#.......#......", "##.#......#...##.........#.###...........#...#.#.......#...#.#..#..##...#..", ".................##.#....#.#..##..................#.##....###......#.......", "..#.#...#......#..###...#.#............#..........#.##..#..#.....#...#.....", ".##....##............#...#.....#.##.....#.#..#.#..##.##......#..........##.", "#.#.......###..####..##..##............##..#...#.#..................#.###.#", "....##.........#.#..#........#..#..##.#......###...#........#.....##..#....", "#...#...#...#.....#.#..#...#.##..................#.##...#.#..#.......#.....", "....#.##.#.###.......#..........#..###.....#....#.#.#.#......#.#..##.#.....", ".#..............##..#.#.........#.#....#S..#.....#.##....#.##...........#..", "..##......#..#.....#.#.#...#.#.....#.#..#####..###...##...#.....#...#.....#", "........#.##..#.##....#......#.##.#......#....#..#.......#.#.....#........#", "......#.....#...##....###.#...#..#..#.......#..#.#....##.#.....#..#.....#..", "..........#.#...#............#....##..###.......#........#..............#..", "..##...#..##.......##......................#.....#.##..#.#...#.....###.#...", "##............##.....#............#.#.....#..##...##..#...#........##......", "#....#....#.........M......#..#..#..#......#......###........#.#........#..", ".#.#..##...#.#...#.#....#.#....#......#.#..#........#............####......", "....#....#....#.#...#....#..#.#....M.....#...........#...#...##.#......#...", "......##...#....#....#..#.#.##.......#....##.#....#..#..#.#...###..##.##...", ".#......#..#.....#.........#....#.............#........##..##....#.....#.#.", ".#.##.##..#..##.##.#....#...#...........#.....#..##................#.##....", "#..#..###......##.##..##.##...............#.........#....##..#...#.#.#....#", "....#.#...##.#.#.......#.#...#....##..............#..##.......##..#..#.....", "...#.#.........##......#.....#..#.##..###..#..#.#........#......##..#.....#", "#.#.....##.##.......#.#.....#......#..##....#....#..#...........#.#..#.....", "...........##...#...#..#....#..##.....#..#...#.##..............#..##.....#.", "......M#.#.#.......##.##....#.#.#........#.##....#........#...###.......#..", "..........###........#......##...#.#...........#....#.##...#.#...#....#....", ".##.....#.......#...#.....#.....#..........#..#....##............#..#..#...", "...........#...#.#.#.#...#.#....#......#........#.#..#...#....#.#..........", ".##...#..#.###..#.........##....#..............#........#.#..#.##M.........", "###....#..#####..#..#..#...#.....#.#......#####.#.........##.#..#....#.#...", "...#..#.......#........#............##.#.#...#.#...#....###..#.............", "..#.#.#....#...#..#..#.#...#......#...###..#..#...#..##..##....#.......#...", "...#......#..##..#..#............###..........#........#...##..##..#....#..", "###........#..##.....#..##......##..#..#.......#..#.....................O..", "........###.#...#......#.......#....#.....#..#..#....##.##..##....#....#.#.", "##..##..##.....##......#....#.#....##.......##.#........##.#..#....####...#", "#..##....#.....##.#.....#.............#...##.#...#...#..#........#.##......", ".##.#.##...........#...........#.......#.##......##..#.......###..#..##...#", "..#........#....##.....#..#......##...##...#.#.#.#......#....#.#..#.....#..", "..#...##.....#.#.#..................#..#.....#..........#..#.M..#........#.", "..#.....##..#.........##...........##....#........#..M...#........#.#......", ".##.##.....#......................#..#.#...#.........#.....#...###....#.#..", "#.##.....#.....#........#.......##..###.........#.#....#.....#..#..##......", "......#.............##......######...#..#.##...#.##.##.....#.#..#.#.#...##."]))
    # print(time.time() - t0)
    # t0 = time.time()
    # print(s.minimalSteps(["......#...............#.....................#.................#......#....#.#...................", "......#.........#......#.....O..#..................#............#........M..##..................", "#.........#............#...#......#............................#...#...............##....#......", ".#..#.#..#.........#........................#......#..............##...........................#", "....#.....#......#.............##..........#..........#............................O............", "...........#..#...#......................#....#....#.................#..........................", "......................#..#.....O....#....#.............................O.......#..##.....#......", "###...##.........#....#...O........................#.................#..##..#..............M#...", "......................#....#....#..........#.#.#....#....#.....#......##..........#..........#..", ".#.#..#....#.............#............#...........#...#.......M.............#..........#...##...", ".........#..#...#.......#......................#......#..................#.#..............#.....", "..........#...#.....................#...........#....#....#....##....#......#..........#........", ".#.....................#..............#......#.#....##.......#....#......#..#............#......", "........#...#.##........#.#...O...........#......#....#......O#...#.......#...#.##....#...#.#...", "......#..............#.............#......#.#........................#.........M..##...#.....#..", ".#..#........#................#......#...##.................#..#.##.#.....#........#.....#..#...", "..#....#..#..........#.......##..#......................#..#.##.#.....#.........................", "..#...#....M##................#.........#...#......................................#.#..........", "#...........#...............#.............#.............#..#....##.#............................", ".....#.O..#....................#..#.#................#............#.......#................#.##.", "...##..............#...#............#.#.........#.......................#...###...........#.#...", "#..##.....#........#...#..........#...#........#......#....#......##...........#..#.......O.....", "....#..........#.......#......#......#..#....O..............#.......#.....#.....MO.#....#.......", ".##..........#....###..#..................#..O..#......#......................................#.", ".....#........#...#...................#..#...####.........#.#..............##.......O...........", ".#............#......#..........#................###..##....#....#......#..#...#......#..#.#....", ".##....#..#.#....#...........................#.........#..#......#.........#.....#.#....M#......", ".....#.#...............#......#.......##.....#.............#.#.#.##.....................#.#.#...", ".............#....#..........##....#.......#........#.......##........O........#........#......M", ".#...............#.....#.....#......#........#....#..#...##.##..........#....O......#...........", ".........#...##.O...............#..........................#................................#...", "........#....##..#....................#.......#.#...#.................#.#.........##............", "...............#..........#.............#...............#...#.....#.......#.....................", "....#..............................#.....#...#......#..........#...........#..............#...#.", "..O...............#........#......#.#........#.#.........#...............#..#.#.#.............#.", "..#............#........................#.#..#...##.......#....##..........#.....#.....#......#.", "...#..#..........#...#......#..#.##.......................O....#...............#......#..#......", "..........##.....#........#..........#..#.............#....................#.......#............", ".........#......#....#.........................#...#.....#..........#..#.....#....#....##......#", "....##......#.#................#.#.....#.##.............#....#..................#...#.....#.....", "..#........#.#.................#.........#..........#............#.............#......##........", "............#....#......#....#.#.......#..............#......#.......#.........#................", ".........##....#................#.#..#............#.....#......#..........................#.##..", "...#..#......####..#......#.#.#..#.....#...........#........#..........#..........M#.M......##..", "...O....#........#.......#........#.#................#..#................#..................#...", "..........#..#...............#..#........#.......#....................#.........................", "..........##.......#..#.##...#...##....#.#..............#.......#.........................#.....", "...........................#...#......................#........#...#..#.....#..#.#.......#......", "................................#......................#.#.#.........#..........#............#.#", "#..#.........#.....................................#........#..#....................#.....#....#", "..#...#.................#.##......#..........#.................#....#...#.......................", ".......#.......#......#...#.#..................................#........#.......................", ".#...........#...........#...#............##.#......M................#...............#..........", "............................#.....#...#..............#................#..#....#...T.....#.....#.", ".#....###....##..........#................................#..............#...........#...#......", "#..#..#.............#.....#...................#........#.......#...#...........................#", "......#..............#.............#...............#.#..................#.....O................#", "........#................................#.#.#....#..#..........#..................#...#........", "..................#...#...........#.........#.............##..........#.#.....#....#......#....#", "..#..#.##..#...............#.........#..#...##...M..#..##...#....#O...............#.....#....##.", "##..#...#...........#.....#.......#.....#M#.#........#...#..........#.......#..#..#.............", "...................................#....##.........#.#.#...............#..........#...#O#.......", "....#...#..#..............................#...........#.#............#..#....#..#...#.#.........", "..#.............#....#..##...#........................#.....#.##......#.............#.....#.....", "...........#...#........#....#...#.............#....#.........#..........#........#.............", "#.....#......#....#..#....#..#.............................#.............#......................", ".......#......#................##..........#....#.......#....#............................#..#.#", "....................................#.............#...#.....#....#..#...#...........#.........#.", "....#.............##.#.......#..#.#..#...#.......#...#..........#..........................##..#", ".......##........###....####............#.#.....................#.....#....#.................#.#", "....#.....#...##......#........#....#.....#.....#..#........#...#.....#..........#...#..........", "#.....#......#.............#....#..........#......................#.#.....#..M......#.......#...", "...............#..O.#..#..#......#......#......#.................#.......#......##........#.....", "..##.....#.#........#.......#.#......#.....#....#......#...##.#....................#.#..........", ".##........#...#...............#...#.........#...#...O....#.......#.......##.#..........#....#..", "...............#..................#........................................................#....", "#..............#..........#.....................#....................#...........#..........#...", "..#....#........#...........#........#.....#.............#.#.............#.......#.#..##..#.#...", "....#..............S......#.........#....#..#.#........#..#....##...........##....#........#....", ".............#.............#.......#...#......................................#............#.###", ".#........#.#..#..#..##.....#......#......................#....#.................#........#.....", "..................#...........#.....##.......##..#........................#........##..O.....#..", "##.....##....#.....#...#..#.....#..........................#...#.#...................#..#.......", "..#...............#.....#.......#...#.......#...#.##...........#......#...#......##....O.......#", ".#...................#...............#....#........#..........#.............#..........#..#.....", "............#.........#.......#...........................#......#......#.......#.......#....#.."]))
    # print(time.time() - t0)
    #
    t0 = time.time()
    print(s.minimalSteps(["...#............#.....#.#.#...###...................#....#.........#...##........#..................","...O......##..............#......#.........#...........#...#....#.........#.........................","..#.#.........#....#........##..............#...................#........O.#...#.........#....#.....",".....#......#..#.#..#........##...........#.....#..................#........#....#..#...............",".#........................#...#...#..#..................................#........#.....#............",".........##......#........##.......#....................#..........O...........#.#.#......#........#","......#....#.......#.......#..#..................#.#............#............#..............#.......","............#..#......#.........#........#......#......#....#.............................#.........","#.#.##....................#...................................#...............#..#..#............#..","..................................................##.#........#...#..................#......#O.....#","#.............M................#..#.......................##.....#..........#..............#.#......","O....#.....#............#...##..........#.......#......#...................#........#...............","O.........................#.#....#..#............................#..........#.......#..........#....",".....O.........#.#..........#..........#.................#........##............#....#.......#......","#......#....#..............#....#............#............#.#.#....#................................","............##..#.....................#.......##..#.#.#........................................#....","...........#.......#...#..#............##..#.........#..#..#..#.........#..#.....#...........##.....","........#......#..#.#...O.....#....#....#............#..........#......#.....................#......","..#.....#..........#....##.#.....................#.#............##...#........##..........#O...#....","........#....#.#..........#..#..................................#..#....#...#.....#.....#.........#.",".#.........#.....................#..#.....#............#.....#.#.........#.......................#..",".....#............................#......##....#....................................#.#........#..#.",".#....#.#.........#............#.......................#.......................#.........#......#...",".......#..........#......................#..#..........#......O.......#..#....#...........O.........",".#O........M....#.##......O.....#......#.#..#...........#..#...#..#..............................#..","....................O...M..........#..........#...#.........#.............#...........#.#...........","#...#.#.....#........#......#.....#...........#...............#.##.....................#..#.........",".....#................#...................##.......#..#.............##...#..#.......................",".....##..........................##............#.............#..........#.#..................#......",".#.....................##.#......#.#.#..........#.#....#................#........#......#...#...#..#",".........#..........#.........O..............#.....M.................#.....#....#...................","...........#......#......##..........#....#.....#..........M...........#....#....##.......#.........","##...................................................#.....#.......##.#.............................","..........#........##..........#..................#......M.#.#.#.........#..........................","....#..#..M#.....M.....#..........M...........#.#............................#......................","..#......#..........#......#..#...##..................#..#...#...................#.......#...#..###.","..................#..#.#.................T..................#.............#..................#......","........#.#...#............#.................#...##.#......#..............#.........................","....#.............#.##.#.........#..##......#.#.#..................................................#","..#.......#.............#.#....#.#.......................#.....#..........#................#........","....#.......................#....#.............#....#....#..........##........#..............#......","#..................#.....O................#....#.#......#.........#......#......................#...","..........#...........#.......O.......##...........#.....................#.........................#","..#................................#.............................#.........#...........#............","..........#.....#.......#..................#............#.........#...#.........O.....#.............","#...#.............#....#........#......#..#........#..........#.............................#.#.....",".......#..........#........O#....#...#.........#...........................................#........",".....##.....#...#..#..#...#....................#......#..#......#...##......O.........#....##.......","................#.....#.........#.............................O.......#............................#",".........#.#.................#.....#....#.........#....#............................................","...#.#...........................#.......#......#............#.#......................###.....O..#..","...................#.#.#......#.......#...............................#......#....#....#............","#.#......#....#........#.#..#.#..........##...##.................#..........#.....................#.",".#....#.......................................#.....#..........#.....M#..........#.....#............","........#.....................#.#............#...............#.#..O.......#...................#.....","....#............................#.......#....#.................................................#...","..................#.#.......#..........#.....#.......#..............#...............#...............",".........................##.........#......#...............#.O..................##............#.....","..##......#..#........#.....................#....#......#.................#...........##.......#....","#..#..#............###..#...............#....#........#..........#..#...........#...............#O..","#..............................#...............#.#....#..#..#..#......#.......#.##............#.....","#.......S.......##.....#...........................###.#...........................#.#............#.",".................................#...........#...........#..........#.....#..#.#...#............#...","...........#....##.....#.............#..#...................................##....................#.","M.#....................#.#...O...............................M......O..................#....#.......","....M#.####........#......................................................#........#................","......#.#..................#................................................##....#.................","...#.............................................###..#...#........................#..#.......#.#...","........#.............O#..#.#....................#..#..#..........#....#.....#......#...#.......#...",".#..##..................#........#..........#........#....#.........##O...............#.....#.......","#.....#.#.#........#.......##....................#..........#.............#...#...#....##........#.#","................#.........#...........#.....#.......##....#..............#..........................","......O........#................##......#.#..................#.........#.............##.............",".#....#.#.........#...#...............#...........##.....#...........#..........M....#............#.","..............#...............O.......#......................#....................#...O..#..........","................#...#.#...#....................#.......#...#..............O.........................",".#................................##.............#...#.#.....#.#................#..#...#............",".....#..............#...............#...............................................................",".......................#....................##..#................#......................#..#.....#..",".........#..#....................#.............#..#......................#.......#..................","#..#........#....................................#.....#..............#..........#......#.#.......#.",".#......................#.....#......#........#....#...#......O#....#.........#....##...............","...........................#.....#...#.........#..#......#.....M......#....#...#............##...O##",".......................#...##............#.........#..............#....#....#..#...#.....#.#........",".#....#.......................#.....#O...#.............................#............#...............","...#.#..............#....M..............#.#.......#...#...#...#..........#........................##",".....#................#.#........#......#....................#.....#................................","....O.....#..................#.#..O...#.........#.......#.#..............#.....#.............#....#.",".......#..#.#..##......#...................#...............#.#.......#.........#....#......#..#....#",".....#.............#...#.......#.#.#........##.....#.#.....#....#......#.#...#................#.....","...............#..........#.#.##...................#.......................#.......##.....#..#.#....",".................#......#............................#...#...##........................#............","#........#........#..........#...#........#.#..#..............#...#.#.....#.#.#.#...................",".........#.#.......###.......#..........#.......#..........................................#........",".#..................#.....#......##.#...........#..........#.....#..................#............#.#","..................................................#.........#..#.#.....##....#...........#..........","......#...........#......#.......#...#.....................#.#............##................#....#..",".#..........................#........#........#.......#........#...#...........###...........#......","#...#...#.......#...................................##........O.........#.....#......#...#..........","#.......#.....#.#....#...#................O...................#..................#.......##........."]))
    print(time.time() - t0)